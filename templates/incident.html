<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incident Report - {{ report_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tab-content {
            border: 1px solid #ddd;
            border-top: none;
            padding: 20px;
        }
        .field-label {
            font-weight: bold;
            color: #495057;
        }
        .field-value {
            margin-bottom: 10px;
        }
        .narrative-section {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .data-section {
            margin-bottom: 30px;
        }
        .loading-spinner {
            text-align: center;
            padding: 50px;
        }
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        .info-card {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .key-info-table {
            margin-bottom: 0;
        }
        .key-info-table th {
            background-color: #f8f9fa;
            width: 40%;
            border-right: 2px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">AVIRD Data Analyzer</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="/">Reports</a>
                    <a class="nav-link" href="/entities">Entity Statistics</a>
                </div>
            </div>
        </nav>

        <div id="loading" class="loading-spinner">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading incident data...</p>
        </div>

        <div id="content" style="display: none;">
            <!-- Header Section -->
            <div class="info-card">
                <h2 id="incidentTitle">Incident Report</h2>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm key-info-table">
                            <tbody>
                                <tr>
                                    <th>Report ID</th>
                                    <td id="reportId"></td>
                                </tr>
                                <tr>
                                    <th>Operating Entity</th>
                                    <td id="operatingEntity"></td>
                                </tr>
                                <tr>
                                    <th>Incident Date</th>
                                    <td id="incidentDate"></td>
                                </tr>
                                <tr>
                                    <th>Location</th>
                                    <td id="location"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm key-info-table">
                            <tbody>
                                <tr>
                                    <th>Automation Engaged</th>
                                    <td id="automationEngaged"></td>
                                </tr>
                                <tr>
                                    <th>Crash With</th>
                                    <td id="crashWith"></td>
                                </tr>
                                <tr>
                                    <th>Highest Injury Severity</th>
                                    <td id="injurySeverity"></td>
                                </tr>
                                <tr>
                                    <th>Property Damage</th>
                                    <td id="propertyDamage"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="incidentTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">
                        Description
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="vehicle-tab" data-bs-toggle="tab" data-bs-target="#vehicle" type="button" role="tab">
                        Vehicle Info
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="environment-tab" data-bs-toggle="tab" data-bs-target="#environment" type="button" role="tab">
                        Environment
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="crash-details-tab" data-bs-toggle="tab" data-bs-target="#crash-details" type="button" role="tab">
                        Crash Details
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="investigation-tab" data-bs-toggle="tab" data-bs-target="#investigation" type="button" role="tab">
                        Investigation
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fault-analysis-tab" data-bs-toggle="tab" data-bs-target="#fault-analysis" type="button" role="tab">
                        Fault Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="interactive-fault-tab" data-bs-toggle="tab" data-bs-target="#interactive-fault" type="button" role="tab">
                        Interactive Fault Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-data-tab" data-bs-toggle="tab" data-bs-target="#all-data" type="button" role="tab">
                        All Data
                    </button>
                </li>
            </ul>

            <!-- Tab Contents -->
            <div class="tab-content" id="incidentTabContent">
                <!-- Description Tab -->
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    <div id="narrativeSection" class="narrative-section" style="display: none;">
                        <h5>Incident Narrative</h5>
                        <p id="narrativeText"></p>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Incident Details</h6>
                            <div class="field-value"><span class="field-label">Time:</span> <span id="incidentTime"></span></div>
                            <div class="field-value"><span class="field-label">Same Incident ID:</span> <span id="sameIncidentId"></span></div>
                            <div class="field-value"><span class="field-label">Notice Received Date:</span> <span id="noticeReceivedDate"></span></div>
                            <div class="field-value"><span class="field-label">Within ODD:</span> <span id="withinOdd"></span></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Source Information</h6>
                            <div id="sourceInfo"></div>
                        </div>
                    </div>
                </div>

                <!-- Vehicle Info Tab -->
                <div class="tab-pane fade" id="vehicle" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Vehicle Information</h6>
                            <div class="field-value"><span class="field-label">Make:</span> <span id="vehicleMake"></span></div>
                            <div class="field-value"><span class="field-label">Model:</span> <span id="vehicleModel"></span></div>
                            <div class="field-value"><span class="field-label">Model Year:</span> <span id="vehicleYear"></span></div>
                            <div class="field-value"><span class="field-label">VIN:</span> <span id="vehicleVin"></span></div>
                            <div class="field-value"><span class="field-label">Mileage:</span> <span id="vehicleMileage"></span></div>
                        </div>
                        <div class="col-md-6">
                            <h6>System Information</h6>
                            <div class="field-value"><span class="field-label">ADS System Version:</span> <span id="adsSystemVersion"></span></div>
                            <div class="field-value"><span class="field-label">ADS Hardware Version:</span> <span id="adsHardwareVersion"></span></div>
                            <div class="field-value"><span class="field-label">ADS Software Version:</span> <span id="adsSoftwareVersion"></span></div>
                            <div class="field-value"><span class="field-label">ADS Equipped:</span> <span id="adsEquipped"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Environment Tab -->
                <div class="tab-pane fade" id="environment" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Road Conditions</h6>
                            <div class="field-value"><span class="field-label">Roadway Type:</span> <span id="roadwayType"></span></div>
                            <div class="field-value"><span class="field-label">Roadway Surface:</span> <span id="roadwaySurface"></span></div>
                            <div class="field-value"><span class="field-label">Roadway Description:</span> <span id="roadwayDescription"></span></div>
                            <div class="field-value"><span class="field-label">Posted Speed Limit:</span> <span id="speedLimit"></span></div>
                            <div class="field-value"><span class="field-label">Lighting:</span> <span id="lighting"></span></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Weather Conditions</h6>
                            <div id="weatherInfo"></div>
                        </div>
                    </div>
                </div>

                <!-- Crash Details Tab -->
                <div class="tab-pane fade" id="crash-details" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Subject Vehicle</h6>
                            <div class="field-value"><span class="field-label">Pre-Crash Movement:</span> <span id="svPreCrashMovement"></span></div>
                            <div class="field-value"><span class="field-label">Pre-crash Speed:</span> <span id="svPrecrashSpeed"></span></div>
                            <div class="field-value"><span class="field-label">Air Bags Deployed:</span> <span id="svAirBags"></span></div>
                            <div class="field-value"><span class="field-label">Vehicle Towed:</span> <span id="svTowed"></span></div>
                            <div class="field-value"><span class="field-label">Contact Areas:</span> <span id="svContactAreas"></span></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Crash Partner</h6>
                            <div class="field-value"><span class="field-label">Pre-Crash Movement:</span> <span id="cpPreCrashMovement"></span></div>
                            <div class="field-value"><span class="field-label">Air Bags Deployed:</span> <span id="cpAirBags"></span></div>
                            <div class="field-value"><span class="field-label">Vehicle Towed:</span> <span id="cpTowed"></span></div>
                            <div class="field-value"><span class="field-label">Contact Areas:</span> <span id="cpContactAreas"></span></div>
                        </div>
                    </div>
                </div>

                <!-- Investigation Tab -->
                <div class="tab-pane fade" id="investigation" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Investigation Details</h6>
                            <div class="field-value"><span class="field-label">Law Enforcement Investigating:</span> <span id="lawEnforcementInvestigating"></span></div>
                            <div class="field-value"><span class="field-label">Investigating Agency:</span> <span id="investigatingAgency"></span></div>
                            <div class="field-value"><span class="field-label">Rep Entity/Mfr Investigating:</span> <span id="repEntInvestigating"></span></div>
                            <div class="field-value"><span class="field-label">Officer Name:</span> <span id="officerName"></span></div>
                            <div class="field-value"><span class="field-label">Officer Phone:</span> <span id="officerPhone"></span></div>
                            <div class="field-value"><span class="field-label">Officer Email:</span> <span id="officerEmail"></span></div>
                        </div>
                        <div class="col-md-6">
                            <h6>Data Availability</h6>
                            <div id="dataAvailability"></div>
                        </div>
                    </div>
                </div>

                <!-- Fault Analysis Tab -->
                <div class="tab-pane fade" id="fault-analysis" role="tabpanel">
                    <div id="faultAnalysisContent">
                        <div id="noFaultData" class="alert alert-info" style="display: none;">
                            <h6>No Fault Analysis Available</h6>
                            <p>No fault analysis has been performed for this incident yet.</p>
                        </div>
                        
                        <div id="faultDataSection" style="display: none;">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="info-card">
                                        <h6>AI Fault Assessment</h6>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="field-value">
                                                    <span class="field-label">AV At Fault:</span> 
                                                    <span id="faultStatus" class="badge"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="field-value">
                                                    <span class="field-label">Fault Percentage:</span> 
                                                    <span id="faultPercentage"></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <h7 class="field-label">Analysis Explanation:</h7>
                                            <div id="faultExplanation" class="mt-2 p-3" style="background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;"></div>
                                        </div>
                                        
                                        <div class="row text-muted small">
                                            <div class="col-md-6">
                                                <span class="field-label">Analysis Version:</span> <span id="faultVersion"></span>
                                            </div>
                                            <div class="col-md-6">
                                                <span class="field-label">Generated:</span> <span id="faultCreatedAt"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="info-card">
                                        <h6>About This Analysis</h6>
                                        <p class="small text-muted">
                                            This fault analysis was generated using AI for entertainment purposes only.
                                            The analysis considers the narrative.
                                        </p>
                                        <p class="small text-muted">
                                            <strong>Note:</strong> This is an automated assessment for entertainment purposes only.
                                            Analysis should not be used as the sole basis for legal or 
                                            insurance decisions.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interactive Fault Analysis Tab -->
                <div class="tab-pane fade" id="interactive-fault" role="tabpanel">
                    <div id="interactiveFaultContent">
                        <!-- Session Start Section -->
                        <div id="sessionStartSection" class="info-card">
                            <h6>Start Interactive Fault Analysis</h6>
                            <p class="text-muted small">
                                Argue whether the autonomous vehicle is at fault. An AI will argue the opposite position, 
                                and an AI judge will make the final decision.
                            </p>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Choose Your Position:</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="userPosition" id="prosecutionRadio" value="prosecution">
                                        <label class="form-check-label" for="prosecutionRadio">
                                            <strong>Prosecution</strong> - Argue the AV is at fault
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="userPosition" id="defenseRadio" value="defense">
                                        <label class="form-check-label" for="defenseRadio">
                                            <strong>Defense</strong> - Argue the AV is not at fault
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <button id="startSessionBtn" class="btn btn-primary" disabled>
                                Start Analysis Session
                            </button>
                        </div>
                        
                        <!-- Active Session Section -->
                        <div id="activeSessionSection" class="info-card" style="display: none;">
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <h6>Interactive Fault Analysis Session</h6>
                                    <div id="sessionInfo" class="text-muted small"></div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button id="endSessionBtn" class="btn btn-warning btn-sm">End & Judge</button>
                                    <button id="newSessionBtn" class="btn btn-secondary btn-sm">New Session</button>
                                </div>
                            </div>
                            
                            <!-- Conversation Display -->
                            <div id="conversationContainer" class="mb-3" style="max-height: 400px; overflow-y: auto; border: 1px solid #e9ecef; border-radius: 5px; padding: 15px;">
                                <div id="conversationHistory"></div>
                            </div>
                            
                            <!-- Argument Input -->
                            <div id="argumentInputSection">
                                <div class="mb-3">
                                    <label for="argumentText" class="form-label">Your Argument:</label>
                                    <textarea id="argumentText" class="form-control" rows="4" maxlength="1000" 
                                        placeholder="Enter your argument here (max 1000 characters)..."></textarea>
                                    <div class="form-text">
                                        <span id="charCount">0</span>/1000 characters
                                    </div>
                                </div>
                                <button id="submitArgumentBtn" class="btn btn-primary">Submit Argument</button>
                                <button id="goToJudgeBtn" class="btn btn-success ms-2">Go to Judge</button>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="processingState" class="text-center py-3" style="display: none;">
                                <div class="spinner-border spinner-border-sm" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <span class="ms-2">Processing your argument...</span>
                            </div>
                        </div>
                        
                        <!-- Final Decision Section -->
                        <div id="finalDecisionSection" class="info-card" style="display: none;">
                            <h6>Final Decision</h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="field-value">
                                                    <span class="field-label">AV At Fault:</span> 
                                                    <span id="finalFaultStatus" class="badge"></span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="field-value">
                                                    <span class="field-label">Fault Percentage:</span> 
                                                    <span id="finalFaultPercentage"></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <span class="field-label">Judge's Reasoning:</span>
                                        <div id="finalReasoning" class="mt-2 p-3" style="background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid #28a745;"></div>
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="info-card" style="background-color: #f8f9fa;">
                                        <h7>Session Complete</h7>
                                        <p class="small text-muted mb-2">
                                            This interactive analysis was generated for entertainment purposes.
                                        </p>
                                        <button id="startNewAnalysis" class="btn btn-primary btn-sm">Start New Analysis</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Error Display -->
                        <div id="interactiveFaultError" class="alert alert-danger" style="display: none;">
                            <h6>Error</h6>
                            <p id="interactiveFaultErrorMessage"></p>
                        </div>
                    </div>
                </div>

                <!-- All Data Tab -->
                <div class="tab-pane fade" id="all-data" role="tabpanel">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm" id="allDataTable">
                            <thead>
                                <tr>
                                    <th>Field</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody id="allDataBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="error" class="error-message" style="display: none;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const reportId = "{{ report_id }}";
            loadIncidentData(reportId);
        });

        async function loadIncidentData(reportId) {
            try {
                const response = await fetch(`/api/incident/${reportId}`);
                const result = await response.json();
                
                if (result.error) {
                    showError(result.error);
                    return;
                }

                const incident = result.incident;
                const faultAnalysis = result.fault_analysis;
                populateIncidentData(incident);
                populateFaultAnalysis(faultAnalysis);
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

            } catch (error) {
                console.error('Error loading incident:', error);
                showError('Failed to load incident data');
            }
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function populateIncidentData(incident) {
            // Header information
            document.getElementById('reportId').textContent = incident.report_id || 'N/A';
            document.getElementById('operatingEntity').textContent = incident.operating_entity || 'N/A';
            document.getElementById('incidentDate').textContent = incident.incident_date || 'N/A';
            document.getElementById('location').textContent = `${incident.city || ''}, ${incident.state || ''}`.trim().replace(/^,|,$/, '') || 'N/A';
            document.getElementById('automationEngaged').textContent = incident.automation_system_engaged || 'N/A';
            document.getElementById('crashWith').textContent = incident.crash_with || 'N/A';
            document.getElementById('injurySeverity').textContent = incident.highest_injury_severity_alleged || 'N/A';
            document.getElementById('propertyDamage').textContent = incident.property_damage || 'N/A';

            // Description tab
            if (incident.narrative) {
                document.getElementById('narrativeSection').style.display = 'block';
                document.getElementById('narrativeText').textContent = incident.narrative;
            }
            document.getElementById('incidentTime').textContent = incident.incident_time_2400 || 'N/A';
            document.getElementById('sameIncidentId').textContent = incident.same_incident_id || 'N/A';
            document.getElementById('noticeReceivedDate').textContent = incident.notice_received_date || 'N/A';
            document.getElementById('withinOdd').textContent = incident.within_odd || 'N/A';

            // Source information
            populateSourceInfo(incident);

            // Vehicle info tab
            document.getElementById('vehicleMake').textContent = incident.make || 'N/A';
            document.getElementById('vehicleModel').textContent = incident.model || 'N/A';
            document.getElementById('vehicleYear').textContent = incident.model_year || 'N/A';
            document.getElementById('vehicleVin').textContent = incident.vin || 'N/A';
            document.getElementById('vehicleMileage').textContent = incident.mileage || 'N/A';
            document.getElementById('adsSystemVersion').textContent = incident.adas_ads_system_version || 'N/A';
            document.getElementById('adsHardwareVersion').textContent = incident.adas_ads_hardware_version || 'N/A';
            document.getElementById('adsSoftwareVersion').textContent = incident.adas_ads_software_version || 'N/A';
            document.getElementById('adsEquipped').textContent = incident.ads_equipped || 'N/A';

            // Environment tab
            document.getElementById('roadwayType').textContent = incident.roadway_type || 'N/A';
            document.getElementById('roadwaySurface').textContent = incident.roadway_surface || 'N/A';
            document.getElementById('roadwayDescription').textContent = incident.roadway_description || 'N/A';
            document.getElementById('speedLimit').textContent = incident.posted_speed_limit_mph ? `${incident.posted_speed_limit_mph} MPH` : 'N/A';
            document.getElementById('lighting').textContent = incident.lighting || 'N/A';

            // Weather information
            populateWeatherInfo(incident);

            // Crash details tab
            document.getElementById('svPreCrashMovement').textContent = incident.sv_pre_crash_movement || 'N/A';
            document.getElementById('svPrecrashSpeed').textContent = incident.sv_precrash_speed_mph ? `${incident.sv_precrash_speed_mph} MPH` : 'N/A';
            document.getElementById('svAirBags').textContent = incident.sv_any_air_bags_deployed || 'N/A';
            document.getElementById('svTowed').textContent = incident.sv_was_vehicle_towed || 'N/A';
            document.getElementById('cpPreCrashMovement').textContent = incident.cp_pre_crash_movement || 'N/A';
            document.getElementById('cpAirBags').textContent = incident.cp_any_air_bags_deployed || 'N/A';
            document.getElementById('cpTowed').textContent = incident.cp_was_vehicle_towed || 'N/A';

            // Contact areas
            populateContactAreas(incident);

            // Investigation tab
            document.getElementById('lawEnforcementInvestigating').textContent = incident.law_enforcement_investigating || 'N/A';
            document.getElementById('investigatingAgency').textContent = incident.investigating_agency || 'N/A';
            document.getElementById('repEntInvestigating').textContent = incident.rep_ent_or_mfr_investigating || 'N/A';
            document.getElementById('officerName').textContent = incident.investigating_officer_name || 'N/A';
            document.getElementById('officerPhone').textContent = incident.investigating_officer_phone || 'N/A';
            document.getElementById('officerEmail').textContent = incident.investigating_officer_email || 'N/A';

            // Data availability
            populateDataAvailability(incident);

            // All data tab
            populateAllData(incident);
        }

        function populateSourceInfo(incident) {
            const sources = [];
            if (incident.source_complaint_claim === 'Y') sources.push('Complaint/Claim');
            if (incident.source_telematics === 'Y') sources.push('Telematics');
            if (incident.source_law_enforcement === 'Y') sources.push('Law Enforcement');
            if (incident.source_field_report === 'Y') sources.push('Field Report');
            if (incident.source_testing === 'Y') sources.push('Testing');
            if (incident.source_media === 'Y') sources.push('Media');
            if (incident.source_other === 'Y') sources.push(`Other: ${incident.source_other_text || ''}`);
            
            document.getElementById('sourceInfo').innerHTML = sources.length > 0 ? sources.join(', ') : 'N/A';
        }

        function populateWeatherInfo(incident) {
            const weather = [];
            if (incident.weather_clear === 'Y') weather.push('Clear');
            if (incident.weather_snow === 'Y') weather.push('Snow');
            if (incident.weather_cloudy === 'Y') weather.push('Cloudy');
            if (incident.weather_fog_smoke === 'Y') weather.push('Fog/Smoke');
            if (incident.weather_rain === 'Y') weather.push('Rain');
            if (incident.weather_severe_wind === 'Y') weather.push('Severe Wind');
            if (incident.weather_other === 'Y') weather.push(`Other: ${incident.weather_other_text || ''}`);
            if (incident.weather_unknown === 'Y') weather.push('Unknown');
            
            document.getElementById('weatherInfo').innerHTML = weather.length > 0 ? weather.join(', ') : 'N/A';
        }

        function populateContactAreas(incident) {
            const svAreas = [];
            const cpAreas = [];
            
            // Subject Vehicle contact areas
            const svContactFields = [
                'sv_contact_area_rear_left', 'sv_contact_area_left', 'sv_contact_area_front_left',
                'sv_contact_area_rear', 'sv_contact_area_top', 'sv_contact_area_front',
                'sv_contact_area_rear_right', 'sv_contact_area_right', 'sv_contact_area_front_right',
                'sv_contact_area_bottom', 'sv_contact_area_unknown'
            ];
            
            svContactFields.forEach(field => {
                if (incident[field] === 'Y') {
                    svAreas.push(field.replace('sv_contact_area_', '').replace(/_/g, ' '));
                }
            });
            
            // Crash Partner contact areas
            const cpContactFields = [
                'cp_contact_area_rear_left', 'cp_contact_area_left', 'cp_contact_area_front_left',
                'cp_contact_area_rear', 'cp_contact_area_top', 'cp_contact_area_front',
                'cp_contact_area_rear_right', 'cp_contact_area_right', 'cp_contact_area_front_right',
                'cp_contact_area_bottom', 'cp_contact_area_unknown'
            ];
            
            cpContactFields.forEach(field => {
                if (incident[field] === 'Y') {
                    cpAreas.push(field.replace('cp_contact_area_', '').replace(/_/g, ' '));
                }
            });
            
            document.getElementById('svContactAreas').textContent = svAreas.length > 0 ? svAreas.join(', ') : 'N/A';
            document.getElementById('cpContactAreas').textContent = cpAreas.length > 0 ? cpAreas.join(', ') : 'N/A';
        }

        function populateDataAvailability(incident) {
            const dataTypes = [];
            if (incident.data_availability_edr === 'Y') dataTypes.push('EDR');
            if (incident.data_availability_police_rpt === 'Y') dataTypes.push('Police Report');
            if (incident.data_availability_telematics === 'Y') dataTypes.push('Telematics');
            if (incident.data_availability_complaints === 'Y') dataTypes.push('Complaints');
            if (incident.data_availability_video === 'Y') dataTypes.push('Video');
            if (incident.data_availability_other === 'Y') dataTypes.push('Other');
            if (incident.data_availability_no_data === 'Y') dataTypes.push('No Data');
            if (incident.data_availability_unknown === 'Y') dataTypes.push('Unknown');
            
            document.getElementById('dataAvailability').innerHTML = dataTypes.length > 0 ? dataTypes.join(', ') : 'N/A';
        }

        function populateAllData(incident) {
            const tbody = document.getElementById('allDataBody');
            tbody.innerHTML = '';
            
            Object.entries(incident).forEach(([key, value]) => {
                const row = document.createElement('tr');
                const fieldCell = document.createElement('td');
                const valueCell = document.createElement('td');
                
                fieldCell.textContent = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                valueCell.textContent = value || 'N/A';
                valueCell.style.wordBreak = 'break-word';
                
                row.appendChild(fieldCell);
                row.appendChild(valueCell);
                tbody.appendChild(row);
            });
        }

        function populateFaultAnalysis(faultData) {
            if (!faultData) {
                // Show "no fault data" message
                document.getElementById('noFaultData').style.display = 'block';
                document.getElementById('faultDataSection').style.display = 'none';
                return;
            }

            // Show fault data section and hide "no data" message
            document.getElementById('faultDataSection').style.display = 'block';
            document.getElementById('noFaultData').style.display = 'none';

            // Populate fault status with appropriate styling
            const faultStatusElement = document.getElementById('faultStatus');
            if (faultData.is_av_at_fault === true || faultData.is_av_at_fault === 1) {
                faultStatusElement.textContent = 'Yes';
                faultStatusElement.className = 'badge bg-danger';
            } else if (faultData.is_av_at_fault === false || faultData.is_av_at_fault === 0) {
                faultStatusElement.textContent = 'No';
                faultStatusElement.className = 'badge bg-success';
            } else {
                faultStatusElement.textContent = 'Unknown';
                faultStatusElement.className = 'badge bg-secondary';
            }

            // Populate fault percentage
            const percentageElement = document.getElementById('faultPercentage');
            if (faultData.av_fault_percentage !== null && faultData.av_fault_percentage !== undefined) {
                const percentage = Math.round(faultData.av_fault_percentage * 100);
                percentageElement.textContent = `${percentage}%`;
                
                // Color code the percentage
                if (percentage >= 75) {
                    percentageElement.style.color = '#dc3545'; // Red
                    percentageElement.style.fontWeight = 'bold';
                } else if (percentage >= 50) {
                    percentageElement.style.color = '#fd7e14'; // Orange
                    percentageElement.style.fontWeight = 'bold';
                } else if (percentage >= 25) {
                    percentageElement.style.color = '#ffc107'; // Yellow
                } else {
                    percentageElement.style.color = '#28a745'; // Green
                }
            } else {
                percentageElement.textContent = 'N/A';
                percentageElement.style.color = '#6c757d';
            }

            // Populate explanation
            document.getElementById('faultExplanation').textContent = 
                faultData.short_explanation_of_decision || 'No explanation provided.';

            // Populate metadata
            document.getElementById('faultVersion').textContent = faultData.fault_version || 'N/A';
            
            // Format the created_at timestamp
            if (faultData.created_at) {
                const date = new Date(faultData.created_at);
                document.getElementById('faultCreatedAt').textContent = date.toLocaleString();
            } else {
                document.getElementById('faultCreatedAt').textContent = 'N/A';
            }
        }

        // Interactive Fault Analysis functionality
        let currentSessionId = null;
        let currentUserPosition = null;

        function initializeInteractiveFault() {
            // Position radio change handler
            document.querySelectorAll('input[name="userPosition"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('startSessionBtn').disabled = false;
                });
            });

            // Character counter for argument
            const argumentText = document.getElementById('argumentText');
            const charCount = document.getElementById('charCount');
            
            argumentText.addEventListener('input', function() {
                const count = this.value.length;
                charCount.textContent = count;
                
                // Color coding
                if (count > 800) {
                    charCount.style.color = '#dc3545'; // Red
                } else if (count > 600) {
                    charCount.style.color = '#ffc107'; // Yellow
                } else {
                    charCount.style.color = '#6c757d'; // Grey
                }
            });

            // Event listeners for buttons
            document.getElementById('startSessionBtn').addEventListener('click', startNewSession);
            document.getElementById('submitArgumentBtn').addEventListener('click', submitArgument);
            document.getElementById('goToJudgeBtn').addEventListener('click', goToJudge);
            document.getElementById('endSessionBtn').addEventListener('click', endSession);
            document.getElementById('newSessionBtn').addEventListener('click', resetToStart);
            document.getElementById('startNewAnalysis').addEventListener('click', resetToStart);
        }

        async function startNewSession() {
            const selectedPosition = document.querySelector('input[name="userPosition"]:checked');
            if (!selectedPosition) {
                showInteractiveFaultError('Please select a position (Prosecution or Defense)');
                return;
            }

            currentUserPosition = selectedPosition.value;
            const reportId = "{{ report_id }}";

            try {
                showProcessing(true);
                
                const response = await fetch(`/api/incident/${reportId}/interactive-fault`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_position: currentUserPosition
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    currentSessionId = result.session_id;
                    showActiveSession();
                    updateSessionInfo(result);
                } else {
                    showInteractiveFaultError(result.detail || 'Failed to start session');
                }
            } catch (error) {
                showInteractiveFaultError('Network error: ' + error.message);
            } finally {
                showProcessing(false);
            }
        }

        async function submitArgument() {
            const argumentText = document.getElementById('argumentText').value.trim();
            
            if (!argumentText) {
                showInteractiveFaultError('Please enter an argument');
                return;
            }

            if (!currentSessionId) {
                showInteractiveFaultError('No active session');
                return;
            }

            const reportId = "{{ report_id }}";

            try {
                showProcessing(true);
                document.getElementById('submitArgumentBtn').disabled = true;
                
                const response = await fetch(`/api/incident/${reportId}/interactive-fault/${currentSessionId}/argue`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        argument: argumentText
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    updateConversationDisplay(result);
                    document.getElementById('argumentText').value = '';
                    document.getElementById('charCount').textContent = '0';
                    
                    // Check if session is complete
                    if (result.status === 'judged') {
                        showFinalDecision(result.final_decision);
                    }
                } else {
                    showInteractiveFaultError(result.detail || 'Failed to process argument');
                }
            } catch (error) {
                showInteractiveFaultError('Network error: ' + error.message);
            } finally {
                showProcessing(false);
                document.getElementById('submitArgumentBtn').disabled = false;
            }
        }

        async function goToJudge() {
            if (!currentSessionId) {
                showInteractiveFaultError('No active session');
                return;
            }

            const reportId = "{{ report_id }}";

            try {
                showProcessing(true);
                
                const response = await fetch(`/api/incident/${reportId}/interactive-fault/${currentSessionId}/end`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    updateConversationDisplay(result);
                    if (result.final_decision) {
                        showFinalDecision(result.final_decision);
                    }
                } else {
                    showInteractiveFaultError(result.detail || 'Failed to get judge decision');
                }
            } catch (error) {
                showInteractiveFaultError('Network error: ' + error.message);
            } finally {
                showProcessing(false);
            }
        }

        function endSession() {
            goToJudge(); // Same as going to judge
        }

        function resetToStart() {
            currentSessionId = null;
            currentUserPosition = null;
            
            // Reset UI
            document.getElementById('sessionStartSection').style.display = 'block';
            document.getElementById('activeSessionSection').style.display = 'none';
            document.getElementById('finalDecisionSection').style.display = 'none';
            document.getElementById('interactiveFaultError').style.display = 'none';
            
            // Reset form
            document.querySelectorAll('input[name="userPosition"]').forEach(radio => {
                radio.checked = false;
            });
            document.getElementById('startSessionBtn').disabled = true;
            document.getElementById('argumentText').value = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('conversationHistory').innerHTML = '';
        }

        function showActiveSession() {
            document.getElementById('sessionStartSection').style.display = 'none';
            document.getElementById('activeSessionSection').style.display = 'block';
            document.getElementById('finalDecisionSection').style.display = 'none';
            document.getElementById('interactiveFaultError').style.display = 'none';
        }

        function updateSessionInfo(sessionData) {
            const userPos = currentUserPosition.charAt(0).toUpperCase() + currentUserPosition.slice(1);
            const aiPos = sessionData.ai_position.charAt(0).toUpperCase() + sessionData.ai_position.slice(1);
            
            document.getElementById('sessionInfo').innerHTML = `
                <strong>Your Position:</strong> ${userPos} | 
                <strong>AI Position:</strong> ${aiPos} | 
                <strong>Round:</strong> <span id="roundCounter">1</span>/3
            `;
        }

        function updateConversationDisplay(sessionData) {
            const conversationHistory = document.getElementById('conversationHistory');
            conversationHistory.innerHTML = '';
            
            if (sessionData.messages && sessionData.messages.length > 0) {
                sessionData.messages.forEach((message, index) => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'mb-3 p-3 rounded';
                    
                    let role = message.role;
                    let bgColor = '#f8f9fa';
                    let textColor = '#000';
                    let speaker = 'Unknown';
                    
                    if (role === 'human') {
                        speaker = `You (${currentUserPosition.charAt(0).toUpperCase() + currentUserPosition.slice(1)})`;
                        bgColor = '#e7f3ff';
                        textColor = '#0056b3';
                    } else if (role === 'ai_advocate') {
                        const aiPosition = currentUserPosition === 'prosecution' ? 'Defense' : 'Prosecution';
                        speaker = `AI Advocate (${aiPosition})`;
                        bgColor = '#fff3cd';
                        textColor = '#856404';
                    } else if (role === 'judge') {
                        speaker = 'AI Judge';
                        bgColor = '#d1ecf1';
                        textColor = '#0c5460';
                    }
                    
                    messageDiv.style.backgroundColor = bgColor;
                    messageDiv.style.color = textColor;
                    messageDiv.style.borderLeft = `4px solid ${textColor}`;
                    
                    messageDiv.innerHTML = `
                        <strong>${speaker}:</strong><br>
                        ${message.content.replace(/\n/g, '<br>')}
                    `;
                    
                    conversationHistory.appendChild(messageDiv);
                });
                
                // Scroll to bottom
                document.getElementById('conversationContainer').scrollTop = 
                    document.getElementById('conversationContainer').scrollHeight;
            }
            
            // Update round counter
            const roundCounterEl = document.getElementById('roundCounter');
            if (roundCounterEl && sessionData.round_count) {
                roundCounterEl.textContent = sessionData.round_count;
            }
        }

        function showFinalDecision(decision) {
            document.getElementById('activeSessionSection').style.display = 'none';
            document.getElementById('finalDecisionSection').style.display = 'block';
            
            // Populate decision data
            const statusElement = document.getElementById('finalFaultStatus');
            if (decision.fault_status === 'Yes') {
                statusElement.textContent = 'Yes';
                statusElement.className = 'badge bg-danger';
            } else if (decision.fault_status === 'No') {
                statusElement.textContent = 'No';
                statusElement.className = 'badge bg-success';
            } else {
                statusElement.textContent = 'Unknown';
                statusElement.className = 'badge bg-secondary';
            }
            
            document.getElementById('finalFaultPercentage').textContent = `${decision.fault_percentage}%`;
            document.getElementById('finalReasoning').textContent = decision.reasoning || decision.full_response;
        }

        function showInteractiveFaultError(message) {
            const errorDiv = document.getElementById('interactiveFaultError');
            const errorMessage = document.getElementById('interactiveFaultErrorMessage');
            
            errorMessage.textContent = message;
            errorDiv.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 10000);
        }

        function showProcessing(show) {
            document.getElementById('processingState').style.display = show ? 'block' : 'none';
            document.getElementById('argumentInputSection').style.display = show ? 'none' : 'block';
        }

        // Initialize interactive fault analysis when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeInteractiveFault();
        });
    </script>

    <footer class="footer mt-5 py-4 text-center bg-light">
        <div class="container">
            <span class="text-muted"> 2025 AVIRD Data Analyzer. For research purposes only.</span>
        </div>
    </footer>
</body>
</html>